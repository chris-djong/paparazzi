<!DOCTYPE flight_plan SYSTEM "../flight_plan.dtd">

<flight_plan alt="10" ground_alt="0" lat0="52.89775888" lon0="4.44938" max_dist_from_home="500" qfu="0" name="Never Landing Drone" security_height="25">

<header>
#include "subsystems/datalink/datalink.h"
</header>
  <waypoints> 
    <!-- Keep this order in waypoints or change the wp_id if conditions in follow_me.c module -->
    <!--  FOLLOW = 3 / AF = 5 / TD = 6 / FLARE = 7 -->
    <waypoint name="HOME" x="0" y="0"/>
    <waypoint name="STDBY" x="0" y="0" height="10"/>
    <waypoint name="FOLLOW" x="0" y="0" height="10"/>
    <waypoint name="FOLLOW2" x="0" y="0" height="10"/>
    <waypoint name="CLIMB" x="0" y="200"/>
    <waypoint name="AF" x="100" y="100" height="50"/> <!--  Start of landing procedure -->
    <waypoint name="TD" x="100" y="0"/>  <!--Touchdown-->
    <waypoint name="FLARE" x="90" y="0"/> <!--Flare waypoint (engine off and landing after touchdown has been obtained) --> 
    
    <!--  Allowable Flying region -->
    <waypoint name="FR_TL" x="-200" y="200"/> <!--  Top Left -->
    <waypoint name="FR_TR" x="200" y="200"/> <!--  Top Right -->
    <waypoint name="FR_BL" x="-200" y="-200"/> <!--  Bottom Left -->
    <waypoint name="FR_BR" x="200" y="-200"/> <!--  Bottom Right -->
  </waypoints>
  
  <sectors>
    <sector name="FlyingRegion" color="red" type="dynamic">
      <corner name="FR_TL"/>
      <corner name="FR_TR"/>
      <corner name="FR_BR"/>
      <corner name="FR_BL"/>
    </sector>
  </sectors>

  <exceptions>
      <exception cond="datalink_time > 60" deroute="Standby"/>
      <!-- <exception cond="!InsideFlyingRegion(GetPosX(), GetPosY())" deroute="Standby"/>  exception removed from here because it standby error at startup-->  
  </exceptions>

  <!-- *********** Initial setup *********** -->
  
  <!-- Kill throttle until we have a GPS fix -->
  <blocks>
    <block name="Wait GPS">
      <set value="1" var="autopilot.kill_throttle"/>
      <while cond="!GpsFixValid()"/>
    </block>
    <!--  Set the reference values as soon as a GPS fix is obtained -->
    <block name="Geo init">
      <while cond="LessThan(NavBlockTime(), 10)"/>
      <call_once fun="NavSetGroundReferenceHere()"/>
      <call_once fun="NavSetAltitudeReferenceHere()"/>
    </block>
    <!--  Don`t continue procedure until RC Link has been established at least once -->
    <block name="Waiting for RC Transmitter">
      <attitude roll="0" throttle="0" vmode="throttle"/> <!-- To disable wriggly Actuators in Auto2, and throttle to 0 just in case -->
      <while cond="RCLost()"/> <!-- To make sure we do not hop to AUTO2 and motor could starts running, at least switch on then maybe off if you want to -->
    </block>
    <!-- Hold throttle kill until Takeoff block is called -->
    <block name="Holding point">
      <set value="1" var="autopilot.kill_throttle"/>
      <attitude roll="0" throttle="0" vmode="throttle"/>
    </block>
    
  <!-- *********** Takeoff *********** -->
    
    <!-- Takeoff in direction of CLIMB waypoint until we have a height of 25 meters -->
    <block key="t" name="Takeoff" strip_button="Takeoff (wp CLIMB)" strip_icon="takeoff.png" group="home">
      <exception cond="GetPosAlt() > GetAltRef()+5" deroute="Standby"/>
      <set value="0" var="autopilot.kill_throttle"/>
      <set value="0" var="autopilot.flight_time"/>
      <go from="HOME" throttle="1.0" vmode="throttle" wp="CLIMB" pitch="15"/>
    </block>
    <!--  After the height of 25 m is obtained we deroute to the standby waypoint for 1 minute-->
    <block key="Ctrl+a" name="Standby" strip_button="Standby" strip_icon="home.png" group="flight">
      <call_once fun="follow_me_stop()"/>
      <call_once fun="rl_soaring_stop()"/>
      <circle radius="nav_radius" wp="STDBY" pre_call="follow_me_set_wp()"/>    
    </block>
    
  <!-- *********** Flight *********** -->

    <!--  Initiate follow_me module  -->
    <block name="follow_me" strip_button="Follow me" group="flight">
      <call_once fun="follow_me_startup()"/>
      <call fun="follow_me_call()"/>
      <exception cond="!InsideFlyingRegion(GetPosX(), GetPosY())" deroute="Standby"/>
    </block>
    
    <block name="reinforce_learning" strip_button="Reinforcement Learning" group="flight">
      <call_once fun="rl_soaring_start()"/>
      <call fun="rl_soaring_call()"/>
      <exception cond="!InsideFlyingRegion(GetPosX(), GetPosY())" deroute="Standby"/>
    </block>
 
    
  <!-- *********** Land *********** -->
    <block name="follow_module_land" strip_button="Follow Land" group="land">
      <stay pre_call="follow_me_set_wp()" climb="-1" vmode="climb" wp="FOLLOW"/>
      <exception cond="!InsideFlyingRegion(GetPosX(), GetPosY())" deroute="Standby"/>
    </block>    
  </blocks>
  
  
  
</flight_plan>
